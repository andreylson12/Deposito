<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Painel - Adega Sistema</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#111111" />
  <style>
    body { margin:0; font-family:Arial, sans-serif; display:flex; height:100vh; background:#1c1c1c; color:#fff; }
    .sidebar{ width:220px; background:#111; padding:20px; }
    .sidebar a{ display:block; margin:10px 0; padding:8px; border-radius:4px; text-decoration:none; color:#fff; cursor:pointer; }
    .sidebar a:hover{ background:#333; }
    .content{ flex:1; padding:20px; overflow-y:auto; }
    section{ display:none; }
    section.active{ display:block; }
    table{ border-collapse:collapse; width:100%; background:#2c3e50; }
    th, td{ padding:8px; border:1px solid #444; vertical-align: top; text-align:center; }
    input, button, select{ padding:8px; margin:5px 0; border-radius:6px; border:none; }
    button{ background:#27ae60; color:#fff; cursor:pointer; }
    button:hover{ background:#219150; }
    .btn-remover{ background:#e74c3c; }
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>Adega</h2>
    <a onclick="mostrarSecao('produtos')">üè∑Ô∏è Produtos</a>
    <a onclick="mostrarSecao('pedidos')">üöö Pedidos</a>
  </div>

  <div class="content">
    <h1>Painel Administrativo</h1>
    <p>Gerencie seus produtos e pedidos.</p>

    <section id="produtos" class="active">
      <h2>üè∑Ô∏è Produtos</h2>
      <form id="formProdutos">
        <input id="nomeProduto" placeholder="Nome" required />
        <input id="precoProduto" type="number" step="0.01" placeholder="Pre√ßo" required />
        <input id="estoqueProduto" type="number" placeholder="Estoque" required />
        <input id="imagemProduto" placeholder="URL da Imagem" />
        <button type="submit">Salvar</button>
      </form>
      <table>
        <thead><tr><th>Nome</th><th>Pre√ßo</th><th>Estoque</th><th>A√ß√µes</th></tr></thead>
        <tbody id="listaProdutos"></tbody>
      </table>
    </section>

    <section id="pedidos">
      <h2>üöö Pedidos</h2>
      <table>
        <thead><tr><th>ID</th><th>Cliente</th><th>Endere√ßo</th><th>Itens</th><th>Total</th><th>Pagamento</th><th>Status</th><th>A√ß√µes</th></tr></thead>
        <tbody id="listaPedidos"></tbody>
      </table>
    </section>
  </div>

  <audio id="alertSound" preload="auto"></audio>

 <script>
  const API = { produtos: "/api/produtos", pedidos: "/api/pedidos" };

  function mostrarSecao(id){
    document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
    document.getElementById(id).classList.add("active");
  }
  const moeda = n => Number(n).toFixed(2).replace('.', ',');

  // Service Worker + Push (ok)
  let swReg = null;
  async function registrarServiceWorker() {
    if ("serviceWorker" in navigator) {
      try {
        swReg = await navigator.serviceWorker.register("/service-worker.js");
        console.log("[SW] registrado", swReg);
      } catch (e) {
        console.warn("[SW] falhou:", e);
      }
    }
  }
  function urlBase64ToUint8Array(base64String){
    const padding = "=".repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
    const rawData = atob(base64);
    return Uint8Array.from([...rawData].map(c => c.charCodeAt(0)));
  }
  async function inscreverPush() {
    if (!("serviceWorker" in navigator) || !("PushManager" in window)) return;
    try {
      const keyRes = await fetch("/api/push/public-key");
      const { publicKey } = await keyRes.json();
      if (!publicKey) { console.warn("PublicKey n√£o dispon√≠vel."); return; }

      const perm = await Notification.requestPermission();
      if (perm !== "granted") { console.warn("Permiss√£o de notifica√ß√£o negada."); return; }

      const reg = swReg || (await navigator.serviceWorker.ready);
      const sub = await reg.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: urlBase64ToUint8Array(publicKey)
      });

      await fetch("/api/push/subscribe", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(sub)
      });
      console.log("[push] inscrito com sucesso.");
    } catch (e) {
      console.warn("[push] erro:", e);
    }
  }
  function notificarBanner(p) {
    if (!("Notification" in window) || Notification.permission !== "granted") return;
    if (swReg && swReg.showNotification) {
      swReg.showNotification("Novo pedido!", {
        body: `#${p.id} ¬∑ ${p.cliente?.nome || "Cliente"} ¬∑ R$ ${moeda(p.total)}`,
        tag: `pedido-${p.id}`,
        vibrate: [100, 50, 100],
        icon: "/icons/icon-192.png",
        badge: "/icons/icon-192.png"
      });
    } else {
      new Notification("Novo pedido!", {
        body: `#${p.id} ¬∑ ${p.cliente?.nome || "Cliente"} ¬∑ R$ ${moeda(p.total)}`,
        tag: `pedido-${p.id}`
      });
    }
  }

  // Produtos
  async function carregarProdutos(){
    const res = await fetch(API.produtos, { cache:"no-store" });
    const produtos = await res.json();
    const tbody = document.getElementById("listaProdutos");
    tbody.innerHTML = "";
    produtos.forEach(p=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${p.nome}</td>
        <td>R$ ${moeda(p.preco)}</td>
        <td>${p.estoque}</td>
        <td><button class="btn-remover" onclick="removerProduto(${p.id})">Excluir</button></td>`;
      tbody.appendChild(tr);
    });
  }
  async function removerProduto(id){
    if(confirm("Excluir?")){
      await fetch(`${API.produtos}/${id}`, { method:"DELETE" });
      carregarProdutos();
    }
  }
  document.getElementById("formProdutos").addEventListener("submit", async e=>{
    e.preventDefault();
    const novo = {
      nome: nomeProduto.value,
      preco: parseFloat(precoProduto.value),
      estoque: parseInt(estoqueProduto.value),
      imagem: imagemProduto.value || "https://via.placeholder.com/300x300?text=Produto"
    };
    await fetch(API.produtos, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(novo)
    });
    e.target.reset();
    carregarProdutos();
  });

  // Pedidos
  let pedidosConhecidos = new Set();
  async function carregarPedidos(){
    const res = await fetch(API.pedidos, { cache:"no-store" });
    const pedidos = await res.json();
    const tbody = document.getElementById("listaPedidos");
    tbody.innerHTML = "";

    pedidos.forEach(p => {
      if (!pedidosConhecidos.has(p.id)) {
        if (pedidosConhecidos.size > 0) notificarBanner(p);
        pedidosConhecidos.add(p.id);
      }
    });

    pedidos.forEach(p=>{
      const itens = (p.itens||[]).map(i => `${i.nome} x${i.quantidade}`).join(", ");
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${p.id}</td>
        <td>${p.cliente?.nome||"-"}</td>
        <td>${p.cliente?.endereco||"-"}</td>
        <td>${itens}</td>
        <td>R$ ${moeda(p.total)}</td>
        <td>${p.pix?"PIX":"Outro"}</td>
        <td>
          <select onchange="atualizarStatus(${p.id}, this.value)">
            <option ${p.status==="Pendente"?"selected":""}>Pendente</option>
            <option ${p.status==="Preparando"?"selected":""}>Preparando</option>
            <option ${p.status==="Saiu para entrega"?"selected":""}>Saiu para entrega</option>
            <option ${p.status==="Conclu√≠do"?"selected":""}>Conclu√≠do</option>
          </select>
        </td>
        <td><button class="btn-remover" onclick="removerPedido(${p.id})">Excluir</button></td>`;
      tbody.appendChild(tr);
    });
  }
  async function atualizarStatus(id, status){
    await fetch(`${API.pedidos}/${id}/status`, {
      method:"PUT",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ status })
    });
    carregarPedidos();
  }
  async function removerPedido(id){
    if(confirm("Excluir pedido?")){
      await fetch(`${API.pedidos}/${id}`, { method:"DELETE" });
      carregarPedidos();
    }
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    registrarServiceWorker().then(inscreverPush);
    carregarProdutos();
    carregarPedidos();
    setInterval(carregarPedidos, 5000);
  });
</script>
