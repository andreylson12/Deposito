<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Painel - Rs lubrificantes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#111111" />
  <style>
    body { margin:0; font-family:Arial, sans-serif; display:flex; height:100vh; background:#1c1c1c; color:#fff; }
    .sidebar{ width:220px; background:#111; padding:20px; }
    .sidebar a{ display:block; margin:10px 0; padding:8px; border-radius:4px; text-decoration:none; color:#fff; cursor:pointer; }
    .sidebar a:hover{ background:#333; }
    .content{ flex:1; padding:20px; overflow-y:auto; }
    section{ display:none; }
    section.active{ display:block; }
    table{ border-collapse:collapse; width:100%; background:#2c3e50; }
    th, td{ padding:8px; border:1px solid #444; vertical-align: top; text-align:center; }
    input, button, select{ padding:8px; margin:5px 0; border-radius:6px; border:none; }
    input[type="number"]{ width:120px; }
    input[type="url"], input[type="text"]{ width:100%; max-width:360px; }
    button{ background:#27ae60; color:#fff; cursor:pointer; }
    button:hover{ background:#219150; }
    .btn-remover{ background:#e74c3c; }
    .btn-editar{ background:#2980b9; }
    .btn-cancelar{ background:#7f8c8d; }
    .btn-salvar{ background:#27ae60; }
    .acao-grid{ display:flex; gap:8px; justify-content:center; flex-wrap:wrap; }
    /* Rodap√© com a soma */
    .total-row td{font-weight:700;background:#152536;color:#fff}
    /* Estado de edi√ß√£o */
    tr.editing{ background:#24394d; }
    .helper{ color:#bbb; font-size:12px; margin-top:2px; word-break:break-all; }
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>Rs lubrificantes</h2>
    <a onclick="mostrarSecao('produtos')">üè∑Ô∏è Produtos</a>
    <a onclick="mostrarSecao('pedidos')">üöö Pedidos</a>
  </div>

  <div class="content">
    <h1>Painel Administrativo</h1>
    <p>Gerencie seus produtos e pedidos.</p>

    <section id="produtos" class="active">
      <h2>üè∑Ô∏è Produtos</h2>
      <form id="formProdutos">
        <input id="nomeProduto" placeholder="Nome" required />
        <input id="precoProduto" type="number" step="0.01" placeholder="Pre√ßo" required />
        <input id="estoqueProduto" type="number" placeholder="Estoque" required />
        <input id="imagemProduto" placeholder="URL da Imagem" />
        <button type="submit">Salvar</button>
        <div class="helper">Dica: voc√™ tamb√©m pode editar produtos direto na tabela abaixo.</div>
      </form>
      <table>
        <thead>
          <tr>
            <th>Nome</th><th>Pre√ßo</th><th>Estoque</th><th>Imagem (URL)</th><th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="listaProdutos"></tbody>
      </table>
    </section>

    <section id="pedidos">
      <h2>üöö Pedidos</h2>
      <table>
        <thead>
          <tr>
            <th>ID</th><th>Cliente</th><th>Endere√ßo</th><th>Itens</th>
            <th>Total</th><th>Pagamento</th><th>Status</th><th>A√ß√µes</th>
          </tr>
        </thead>

        <tbody id="listaPedidos"></tbody>

        <!-- Rodap√© com auto-soma -->
        <tfoot>
          <tr class="total-row">
            <td colspan="4" style="text-align:right">Total geral:</td>
            <td id="tdTotalGeral">R$ 0,00</td>
            <td colspan="3"></td>
          </tr>
        </tfoot>
      </table>
    </section>
  </div>

  <audio id="alertSound" preload="auto"></audio>

  <script>
    const API = { produtos: "/api/produtos", pedidos: "/api/pedidos" };

    function mostrarSecao(id){
      document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    }
    const moeda = n => Number(n).toFixed(2).replace('.', ',');

    // ---------------- Service Worker + Push (opcional) ----------------
    let swReg = null;
    async function registrarServiceWorker() {
      if ("serviceWorker" in navigator) {
        try {
          swReg = await navigator.serviceWorker.register("/service-worker.js");
          console.log("[SW] registrado", swReg);
        } catch (e) {
          console.warn("[SW] falhou:", e);
        }
      }
    }
    function urlBase64ToUint8Array(base64String){
      const padding = "=".repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
      const rawData = atob(base64);
      return Uint8Array.from([...rawData].map(c => c.charCodeAt(0)));
    }
    // Silencia quando n√£o h√° endpoint/chave p√∫blica
    async function inscreverPush() {
      if (!("serviceWorker" in navigator) || !("PushManager" in window)) return;
      try {
        const keyRes = await fetch("/api/push/public-key");
        if (!keyRes.ok) return;
        const { publicKey } = await keyRes.json();
        if (!publicKey) return;

        const perm = await Notification.requestPermission();
        if (perm !== "granted") return;

        const reg = swReg || (await navigator.serviceWorker.ready);
        const sub = await reg.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: urlBase64ToUint8Array(publicKey)
        });

        await fetch("/api/push/subscribe", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(sub)
        });
      } catch (_) { /* silencioso */ }
    }
    function notificarBanner(p) {
      if (!("Notification" in window) || Notification.permission !== "granted") return;
      if (swReg && swReg.showNotification) {
        swReg.showNotification("Novo pedido!", {
          body: `#${p.id} ¬∑ ${p.cliente?.nome || "Cliente"} ¬∑ R$ ${moeda(p.total)}`,
          tag: `pedido-${p.id}`,
          vibrate: [100, 50, 100],
          icon: "/icons/icon-192.png",
          badge: "/icons/icon-192.png"
        });
      } else {
        new Notification("Novo pedido!", {
          body: `#${p.id} ¬∑ ${p.cliente?.nome || "Cliente"} ¬∑ R$ ${moeda(p.total)}`,
          tag: `pedido-${p.id}`
        });
      }
    }

    // ---------------- Produtos (com edi√ß√£o inline est√°vel) ----------------
    const estadoEdicao = new Map(); // id -> { nome, preco, estoque, imagem, original }

    async function carregarProdutos(){
      const res = await fetch(API.produtos, { cache:"no-store" });
      const produtos = await res.json();
      const tbody = document.getElementById("listaProdutos");
      tbody.innerHTML = "";
      produtos.forEach(p=>{
        const tr = document.createElement("tr");
        tr.dataset.id = p.id; // <- id do backend (Rails)
        tr.innerHTML = renderLinhaProdutoView(p);
        tbody.appendChild(tr);
      });
    }

    function renderLinhaProdutoView(p){
      const img = p.imagem || "https://via.placeholder.com/300x300?text=Produto";
      return `
        <td title="${escapeHtml(p.nome)}">${escapeHtml(p.nome)}</td>
        <td>R$ ${moeda(p.preco)}</td>
        <td>${Number(p.estoque)}</td>
        <td><div class="helper">${escapeHtml(img)}</div></td>
        <td>
          <div class="acao-grid">
            <button class="btn-editar" onclick="editarProduto(${p.id})">Editar</button>
            <button class="btn-remover" onclick="removerProduto(${p.id})">Excluir</button>
          </div>
        </td>
      `;
    }

    function renderLinhaProdutoEdit(p){
      const valores = estadoEdicao.get(p.id) || { nome:p.nome, preco:p.preco, estoque:p.estoque, imagem:p.imagem || "" };
      return `
        <td>
          <input type="text" id="edit-nome-${p.id}" value="${escapeAttr(valores.nome)}" placeholder="Nome" />
        </td>
        <td>
          <input type="number" id="edit-preco-${p.id}" value="${Number(valores.preco)}" step="0.01" min="0" placeholder="Pre√ßo" />
        </td>
        <td>
          <input type="number" id="edit-estoque-${p.id}" value="${parseInt(valores.estoque||0)}" min="0" placeholder="Estoque" />
        </td>
        <td>
          <input type="url" id="edit-imagem-${p.id}" value="${escapeAttr(valores.imagem || "")}" placeholder="URL da imagem" />
          <div class="helper">Dica: deixe vazio para manter a atual.</div>
        </td>
        <td>
          <div class="acao-grid">
            <button class="btn-salvar" onclick="salvarProduto()">Salvar</button>
            <button class="btn-cancelar" onclick="cancelarEdicao(${p.id})">Cancelar</button>
          </div>
        </td>
      `;
    }

    function editarProduto(id){
      const tr = document.querySelector(`tr[data-id="${id}"]`);
      if (!tr) return;
      if (tr.classList.contains("editing")) return;

      // captura dados atuais da linha (view)
      const tds = tr.querySelectorAll("td");
      const atual = {
        nome: tds[0].innerText.trim(),
        preco: parseFloat((tds[1].innerText || "0").replace(/[^\d,.-]/g,"").replace(".","").replace(",", ".")) || 0,
        estoque: parseInt(tds[2].innerText) || 0,
        imagem: (tds[3].querySelector(".helper")?.textContent || "").trim()
      };
      estadoEdicao.set(id, { ...atual, original: atual });

      tr.classList.add("editing");
      tr.innerHTML = renderLinhaProdutoEdit({ id, ...atual });

      // atalhos
      const inputs = tr.querySelectorAll("input");
      inputs.forEach(inp=>{
        inp.addEventListener("keydown", (e)=>{
          if (e.key === "Enter") salvarProduto();
          if (e.key === "Escape") cancelarEdicao(id);
        });
      });
      tr.querySelector(`#edit-nome-${id}`)?.focus();
    }

    function cancelarEdicao(id){
      const tr = document.querySelector(`tr[data-id="${id}"]`);
      if (!tr) return;
      const st = estadoEdicao.get(id);
      const p = st?.original
        ? { id, ...st.original }
        : { id, nome: "-", preco: 0, estoque: 0, imagem: "" };
      tr.classList.remove("editing");
      tr.innerHTML = renderLinhaProdutoView(p);
      estadoEdicao.delete(id);
    }

    // Atualiza SEMPRE usando o id do DOM (data-id da linha em edi√ß√£o)
    async function salvarProduto(){
      const tr = document.querySelector("tr.editing");
      if (!tr) return;
      const id = Number(tr.dataset.id);
      if (!id) { alert("ID do produto n√£o encontrado."); return; }

      const nome    = (document.getElementById(`edit-nome-${id}`)?.value || "").trim();
      const preco   = parseFloat(document.getElementById(`edit-preco-${id}`)?.value || "0");
      const estoque = parseInt(document.getElementById(`edit-estoque-${id}`)?.value || "0");
      const imagem  = (document.getElementById(`edit-imagem-${id}`)?.value || "").trim();

      if (!nome) return alert("Informe o nome.");
      if (Number.isNaN(preco) || preco < 0) return alert("Pre√ßo inv√°lido.");
      if (!Number.isInteger(estoque) || estoque < 0) return alert("Estoque inv√°lido.");

      const payload = { nome, preco, estoque };
      if (imagem) payload.imagem = imagem;

      try{
        // PATCH (padr√£o Rails) + fallback PUT
        let res = await fetch(`${API.produtos}/${id}`, {
          method:"PATCH",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });
        if (!res.ok) {
          // fallback para PUT se o host s√≥ aceitar PUT
          res = await fetch(`${API.produtos}/${id}`, {
            method:"PUT",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify(payload)
          });
        }
        if (!res.ok) {
          const txt = await res.text().catch(()=> "");
          throw new Error(`Falha ao atualizar produto (HTTP ${res.status}) ${txt}`);
        }
        await carregarProdutos();
      }catch(e){
        console.error(e);
        alert("Erro ao salvar. Veja o console para detalhes.");
      }finally{
        estadoEdicao.delete(id);
      }
    }

    // Utilit√°rios para escapar HTML
    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
      }[s]));
    }
    function escapeAttr(str){
      return escapeHtml(str).replace(/"/g, "&quot;");
    }

    async function removerProduto(id){
      if(confirm("Excluir?")){
        await fetch(`${API.produtos}/${id}`, { method:"DELETE" });
        carregarProdutos();
      }
    }

    // Cria√ß√£o de produto
    document.getElementById("formProdutos").addEventListener("submit", async e=>{
      e.preventDefault();
      const novo = {
        nome: nomeProduto.value,
        preco: parseFloat(precoProduto.value),
        estoque: parseInt(estoqueProduto.value),
        imagem: imagemProduto.value || "https://via.placeholder.com/300x300?text=Produto"
      };
      await fetch(API.produtos, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(novo)
      });
      e.target.reset();
      carregarProdutos();
    });

    // ---------------- Pedidos ----------------
    function atualizarAutoSoma(pedidos){
      const total = (Array.isArray(pedidos) ? pedidos : [])
        .reduce((s, p) => s + Number(p.total || 0), 0);
      const td = document.getElementById('tdTotalGeral');
      if (td) td.textContent = 'R$ ' + moeda(total);
    }

    let pedidosConhecidos = new Set();
    async function carregarPedidos(){
      const res = await fetch(API.pedidos, { cache:"no-store" });
      const pedidos = await res.json();
      const tbody = document.getElementById("listaPedidos");
      tbody.innerHTML = "";

      pedidos.forEach(p => {
        if (!pedidosConhecidos.has(p.id)) {
          if (pedidosConhecidos.size > 0) notificarBanner(p);
          pedidosConhecidos.add(p.id);
        }
      });

      pedidos.forEach(p=>{
        const itens = (p.itens||[]).map(i => `${i.nome} x${i.quantidade}`).join(", ");
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${p.id}</td>
          <td>${p.cliente?.nome||"-"}</td>
          <td>${p.cliente?.endereco||"-"}</td>
          <td>${escapeHtml(itens)}</td>
          <td>R$ ${moeda(p.total)}</td>
          <td>${p.pix?"PIX":"Outro"}</td>
          <td>
            <select onchange="atualizarStatus(${p.id}, this.value)">
              <option ${p.status==="Pendente"?"selected":""}>Pendente</option>
              <option ${p.status==="Preparando"?"selected":""}>Preparando</option>
              <option ${p.status==="Saiu para entrega"?"selected":""}>Saiu para entrega</option>
              <option ${p.status==="Conclu√≠do"?"selected":""}>Conclu√≠do</option>
            </select>
          </td>
          <td><button class="btn-remover" onclick="removerPedido(${p.id})">Excluir</button></td>`;
        tbody.appendChild(tr);
      });

      atualizarAutoSoma(pedidos);
    }

    async function atualizarStatus(id, status){
      await fetch(`${API.pedidos}/${id}/status`, {
        method:"PUT",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ status })
      });
      carregarPedidos();
    }
    async function removerPedido(id){
      if(confirm("Excluir pedido?")){
        await fetch(`${API.pedidos}/${id}`, { method:"DELETE" });
        carregarPedidos();
      }
    }

    // ---------------- Bootstrap ----------------
    document.addEventListener("DOMContentLoaded", ()=>{
      registrarServiceWorker().then(inscreverPush);
      carregarProdutos();
      carregarPedidos();
      setInterval(carregarPedidos, 5000);

      // Duplo clique numa linha de produto -> editar
      document.getElementById("listaProdutos").addEventListener("dblclick", (e)=>{
        const tr = e.target.closest("tr[data-id]");
        if (tr) editarProduto(Number(tr.dataset.id));
      });
    });
  </script>
</body>
</html>

