<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Painel - Adega Sistema</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { margin:0; font-family:Arial, sans-serif; display:flex; height:100vh; background:#1c1c1c; color:#fff; }
    .sidebar{ width:220px; background:#111; padding:20px; }
    .sidebar a{ display:block; margin:10px 0; padding:8px; border-radius:4px; text-decoration:none; color:#fff; cursor:pointer; }
    .sidebar a:hover{ background:#333; }
    .content{ flex:1; padding:20px; overflow-y:auto; }
    section{ display:none; }
    section.active{ display:block; }
    table{ border-collapse:collapse; width:100%; background:#2c3e50; }
    th, td{ padding:8px; border:1px solid #444; vertical-align: top; text-align:center; }
    input, button, select{ padding:8px; margin:5px 0; border-radius:6px; border:none; }
    button{ background:#27ae60; color:#fff; cursor:pointer; }
    button:hover{ background:#219150; }
    .btn-remover{ background:#e74c3c; }
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>Adega</h2>
    <a onclick="mostrarSecao('produtos')">üè∑Ô∏è Produtos</a>
    <a onclick="mostrarSecao('pedidos')">üöö Pedidos</a>
  </div>

  <div class="content">
    <h1>Painel Administrativo</h1>
    <p>Gerencie seus produtos e pedidos.</p>

    <section id="produtos" class="active">
      <h2>üè∑Ô∏è Produtos</h2>
      <form id="formProdutos">
        <input id="nomeProduto" placeholder="Nome" required />
        <input id="precoProduto" type="number" step="0.01" placeholder="Pre√ßo" required />
        <input id="estoqueProduto" type="number" placeholder="Estoque" required />
        <input id="imagemProduto" placeholder="URL da Imagem" />
        <button type="submit">Salvar</button>
      </form>
      <table>
        <thead><tr><th>Nome</th><th>Pre√ßo</th><th>Estoque</th><th>A√ß√µes</th></tr></thead>
        <tbody id="listaProdutos"></tbody>
      </table>
    </section>

    <section id="pedidos">
      <h2>üöö Pedidos</h2>
      <table>
        <thead><tr><th>ID</th><th>Cliente</th><th>Endere√ßo</th><th>Itens</th><th>Total</th><th>Pagamento</th><th>Status</th><th>A√ß√µes</th></tr></thead>
        <tbody id="listaPedidos"></tbody>
      </table>
    </section>
  </div>

  <!-- som do alerta; coloque /public/som_alerta.mp3. Se n√£o existir, usaremos fallback -->
  <audio id="alertSound" src="/som_alerta.mp3" preload="auto"></audio>

  <script>
    const API = { produtos: "/api/produtos", pedidos: "/api/pedidos" };

    function mostrarSecao(id){
      document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    }
    const moeda = n => Number(n).toFixed(2).replace('.', ',');

    // ====== ALERTAS (som + banner + vibra√ß√£o) ======
    const alertEl = document.getElementById("alertSound");
    let pedidosConhecidos = new Set();  // ids j√° vistos (evita alarme na 1¬™ carga)

    // fallback de som caso /som_alerta.mp3 n√£o exista
    (function garantirSom(){
      const fallbackBeep = "data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYAAAABAAACAAA=";
      fetch("/som_alerta.mp3", { method: "HEAD", cache: "no-store" })
        .then(r => { if (!r.ok) alertEl.src = fallbackBeep; })
        .catch(() => { alertEl.src = fallbackBeep; });
    })();

    // Desbloqueia √°udio no mobile no 1¬∫ gesto
    (function desbloquearAudioUmaVez(){
      const tryUnlock = async () => { try { await alertEl.play(); alertEl.pause(); } catch {} };
      window.addEventListener("touchstart", tryUnlock, { once:true });
      window.addEventListener("click",      tryUnlock, { once:true });
    })();

    async function tocarAlerta(){
      if (!alertEl) return;
      try { alertEl.currentTime = 0; await alertEl.play(); }
      catch { console.warn("Som bloqueado (autoplay). Toque uma vez na tela para habilitar."); }
    }

    // Notifica√ß√µes nativas
    (function pedirPermissaoNotificacao(){
      if ("Notification" in window && Notification.permission === "default") {
        Notification.requestPermission().catch(()=>{});
      }
    })();

    function notificarBanner(p){
      if (!("Notification" in window) || Notification.permission !== "granted") return;
      new Notification("Novo pedido!", {
        body: `#${p.id} ¬∑ ${p.cliente?.nome || "Cliente"} ¬∑ R$ ${Number(p.total).toFixed(2).replace('.', ',')}`,
        tag: `pedido-${p.id}`,
        icon: "/icone_pedido.png" // opcional (coloque em /public)
      });
    }
    function vibrarCurto(){ if (navigator.vibrate) navigator.vibrate(200); }
    // ================================================

    // -------- PRODUTOS --------
    async function carregarProdutos(){
      try{
        const res = await fetch(API.produtos, { cache:"no-store" });
        if(!res.ok) throw new Error("Falha ao carregar produtos");
        const produtos = await res.json();
        const tbody = document.getElementById("listaProdutos");
        tbody.innerHTML = "";
        produtos.forEach(p=>{
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${p.nome}</td>
            <td>R$ ${moeda(p.preco)}</td>
            <td>${p.estoque}</td>
            <td><button class="btn-remover" onclick="removerProduto(${p.id})">Excluir</button></td>`;
          tbody.appendChild(tr);
        });
      }catch(e){
        console.error(e);
        // mant√©m a tela sem popup
      }
    }

    async function removerProduto(id){
      if(confirm("Excluir?")){
        await fetch(`${API.produtos}/${id}`,{method:"DELETE"});
        carregarProdutos();
      }
    }

    document.getElementById("formProdutos").addEventListener("submit", async e=>{
      e.preventDefault();
      const novo = {
        nome: nomeProduto.value,
        preco: parseFloat(precoProduto.value),
        estoque: parseInt(estoqueProduto.value),
        imagem: imagemProduto.value || "https://via.placeholder.com/300x300?text=Produto"
      };
      await fetch(API.produtos, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(novo)
      });
      e.target.reset();
      carregarProdutos();
    });

    // -------- PEDIDOS --------
    let falhasSeguidas = 0;

    async function carregarPedidos(){
      try{
        const res = await fetch(API.pedidos, { cache:"no-store" });
        if(!res.ok) throw new Error("HTTP " + res.status);
        const pedidos = await res.json();

        const tbody = document.getElementById("listaPedidos");
        tbody.innerHTML = "";

        // 1¬™ carga: registra ids e N√ÉO toca
        if (pedidosConhecidos.size === 0) {
          pedidos.forEach(p => pedidosConhecidos.add(p.id));
        } else {
          // cargas seguintes: alerta s√≥ para ids novos
          pedidos.forEach(p => {
            if (!pedidosConhecidos.has(p.id)) {
              pedidosConhecidos.add(p.id);
              tocarAlerta();
              notificarBanner(p);
              vibrarCurto();
            }
          });
        }

        pedidos.forEach(p=>{
          const itens = (p.itens || []).map(i => `${i.nome} x${i.quantidade}`).join(", ");
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${p.id}</td>
            <td>${p.cliente?.nome || "-"}</td>
            <td>${p.cliente?.endereco || "-"}</td>
            <td>${itens}</td>
            <td>R$ ${moeda(p.total)}</td>
            <td>${p.pix ? "PIX" : "Outro"}</td>
            <td>
              <select onchange="atualizarStatus(${p.id}, this.value)">
                <option ${p.status==="Pendente"?"selected":""}>Pendente</option>
                <option ${p.status==="Preparando"?"selected":""}>Preparando</option>
                <option ${p.status==="Saiu para entrega"?"selected":""}>Saiu para entrega</option>
                <option ${p.status==="Conclu√≠do"?"selected":""}>Conclu√≠do</option>
              </select>
            </td>
            <td><button class="btn-remover" onclick="removerPedido(${p.id})">Excluir</button></td>`;
          tbody.appendChild(tr);
        });

        falhasSeguidas = 0; // OK
      }catch(e){
        console.warn("Falha ao carregar pedidos:", e);
        falhasSeguidas++;
        const espera = Math.min(15000, 2000 * falhasSeguidas); // 2s -> 15s
        setTimeout(carregarPedidos, espera);
      }
    }

    async function atualizarStatus(id, status){
      await fetch(`${API.pedidos}/${id}/status`, {
        method:"PUT",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ status })
      });
      carregarPedidos();
    }

    async function removerPedido(id){
      if(confirm("Excluir pedido?")){
        await fetch(`${API.pedidos}/${id}`, { method:"DELETE" });
        carregarPedidos();
      }
    }

    document.addEventListener("DOMContentLoaded", ()=>{
      carregarProdutos();
      carregarPedidos();
      setInterval(carregarPedidos, 5000);
    });
  </script>
</body>
</html>
